
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../engine/">
      
      
        <link rel="next" href="../../orm/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.7">
    
    
      
        <title>Работа с транзакциями и DBAPI - SQL Alchemy 2.0 Russian</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.ded33207.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
        html.glightbox-open { overflow: initial; height: 100%; }
        .gslide-title { margin-top: 0px; user-select: text; }
        .gslide-desc { color: #666; user-select: text; }
        .gslide-image img { background: white; }
        
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
            </style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#dbapi" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="SQL Alchemy 2.0 Russian" class="md-header__button md-logo" aria-label="SQL Alchemy 2.0 Russian" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            SQL Alchemy 2.0 Russian
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Работа с транзакциями и DBAPI
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_3" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9h-1.9M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69m-9.15 3.96h2.3L12 9l-1.15 3.65Z"/></svg>
            </label>
          
        
          
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
          
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_3">
          
            <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="SQL Alchemy 2.0 Russian" class="md-nav__button md-logo" aria-label="SQL Alchemy 2.0 Russian" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    SQL Alchemy 2.0 Russian
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        SQLAlchemy начало
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../">Унифицированное руководство SQLAlchemy</a>
          
            <label for="__nav_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Унифицированное руководство SQLAlchemy
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../engine/" class="md-nav__link">
        Установка соединения - Engine
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Работа с транзакциями и DBAPI
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Работа с транзакциями и DBAPI
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dbapi" class="md-nav__link">
    Работа с транзакциями и DBAPI
  </a>
  
    <nav class="md-nav" aria-label="Работа с транзакциями и DBAPI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getting-a-connection" class="md-nav__link">
    Получение соединения
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#committing-changes" class="md-nav__link">
    Фиксируем изменения
  </a>
  
    <nav class="md-nav" aria-label="Фиксируем изменения">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mark-1" class="md-nav__link">
    примечание [1]
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statements" class="md-nav__link">
    Основы выполнения утверждений(statements)
  </a>
  
    <nav class="md-nav" aria-label="Основы выполнения утверждений(statements)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    Извлечение строк
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    Передача параметров
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
        
          
            
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../orm/">ORM</a>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          ORM
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
        
          
            
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../core/">SQLAlchemy Core</a>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          SQLAlchemy Core
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
        
          
            
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../dialects/">Диалекты</a>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Диалекты
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
        
          
            
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../glossary/">Глоссарий</a>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Глоссарий
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dbapi" class="md-nav__link">
    Работа с транзакциями и DBAPI
  </a>
  
    <nav class="md-nav" aria-label="Работа с транзакциями и DBAPI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getting-a-connection" class="md-nav__link">
    Получение соединения
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#committing-changes" class="md-nav__link">
    Фиксируем изменения
  </a>
  
    <nav class="md-nav" aria-label="Фиксируем изменения">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mark-1" class="md-nav__link">
    примечание [1]
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statements" class="md-nav__link">
    Основы выполнения утверждений(statements)
  </a>
  
    <nav class="md-nav" aria-label="Основы выполнения утверждений(statements)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    Извлечение строк
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    Передача параметров
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Работа с транзакциями и DBAPI</h1>

<h2 id="dbapi">Работа с транзакциями и DBAPI</h2>
<p>С Engine готовым к использованию, мы можем приступить к изучению основных операций с Engine и его основных интерактивных
точек, Connection и Result. Кроме того, мы введем фасад ORM для этих объектов, известный как Session.</p>
<details class="info" open="open">
<summary>Примечание для читателей ORM</summary>
<p>При использовании ORM Engine управляется другим объектом, называемым Session. Session в современном SQLAlchemy
подчеркивает транзакционную и SQL-экспертную модель, которая в основном идентична обсуждаемой ниже Connection, поэтому,
хотя этот подраздел сосредоточен на Core, все эти концепции существенно важны для ORM-пользователей и рекомендуются для
всех изучающих ORM. Образец использования Connection будет сопоставлен с Session в конце этого раздела.</p>
</details>
<p>Поскольку мы еще не вводили Expression Language SQLAlchemy, который является основной особенностью SQLAlchemy, мы будем
использовать одну простую конструкцию внутри этого пакета, называемую text(), которая позволяет нам записывать
SQL-запросы в виде текстового SQL. Не стоит беспокоиться о том, что текстовый SQL в повседневном использовании
SQLAlchemy является скорее исключением, а не правилом для большинства задач, хотя он всегда остается полностью
доступным.</p>
<hr />
<h3 id="getting-a-connection">Получение соединения</h3>
<p>Единственная цель объекта Engine с точки зрения пользователя - предоставить единицу подключения к базе данных,
называемую Connection. При работе с Core напрямую, объект Connection является единственным способом взаимодействия с
базой данных. Так как Connection представляет открытый ресурс для доступа к базе данных, мы всегда должны ограничивать
область его использования конкретным контекстом, а лучший способ сделать это - использовать форму менеджера контекста
Python, также известную как оператор with. Ниже мы иллюстрируем "Hello World", используя текстовый SQL-запрос. Текстовый
SQL генерируется с помощью конструкции text(), о которой будет более подробно рассказано позже:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">text</span>

<span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;select &#39;hello world&#39;&quot;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

<span class="c1"># сгенерированный SQL</span>
<span class="n">BEGIN</span><span class="p">(</span><span class="n">implicit</span><span class="p">)</span>
<span class="n">select</span>
<span class="s1">&#39;hello world&#39;</span>
<span class="p">[</span><span class="o">...</span><span class="p">]()</span>

<span class="c1"># распечатанный result полученный в ходе execute (Python)</span>
<span class="p">[(</span><span class="s1">&#39;hello world&#39;</span><span class="p">,)]</span>

<span class="c1"># SQL откат транзакции</span>
<span class="n">ROLLBACK</span>
</code></pre></div>
<p>В приведенном выше примере, менеджер контекста предоставил подключение к базе данных и также ограничил операцию в рамках
транзакции. По умолчанию поведение Python DBAPI включает то, что транзакция всегда находится в процессе; когда область
действия соединения освобождается, выполняется операция ROLLBACK для завершения транзакции. Транзакция не фиксируется
автоматически; когда мы хотим зафиксировать данные, мы обычно должны вызывать Connection.commit(), как мы увидим в
следующем разделе.</p>
<div class="admonition tip">
<p class="admonition-title">Совет</p>
<p>"Автовыполнение" режима доступен для специальных случаев. Раздел "Установка уровней изоляции транзакции", включая "DBAPI
Autocommit", описывает это.</p>
</div>
<p>Результат нашего SELECT также был возвращен в объекте Result, который будет обсуждаться позже, однако на данный момент
стоит отметить, что лучше всего убедиться, что этот объект используется внутри блока "connect" и не передается за его
пределы.</p>
<hr />
<h3 id="committing-changes">Фиксируем изменения</h3>
<p>Мы только что узнали, что соединение с БД через DBAPI не имеет автофиксации. Что, если мы хотим зафиксировать
некоторые данные? Мы можем изменить наш предыдущий пример, создав таблицу и добавив некоторые данные. Транзакция затем
фиксируется с помощью метода Connection.commit(), вызванного внутри блока, где мы получили объект Connection:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># &quot;commit as you go&quot;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE some_table (x int, y int)&quot;</span><span class="p">))</span>
<span class="o">...</span>     <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="o">...</span>     <span class="n">text</span><span class="p">(</span><span class="s2">&quot;INSERT INTO some_table (x, y) VALUES (:x, :y)&quot;</span><span class="p">),</span>
<span class="o">...</span>             <span class="p">[{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}],</span>
<span class="o">...</span>         <span class="p">)</span>
<span class="o">...</span>     <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="c1"># выполненный SQL</span>
<span class="n">BEGIN</span> <span class="p">(</span><span class="n">implicit</span><span class="p">)</span>
<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">some_table</span> <span class="p">(</span><span class="n">x</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span> <span class="nb">int</span><span class="p">)</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="p">()</span>
<span class="o">&lt;</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">CursorResult</span> <span class="nb">object</span> <span class="n">at</span> <span class="mi">0</span><span class="n">x</span><span class="o">...&gt;</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">some_table</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="err">?</span><span class="p">,</span> <span class="err">?</span><span class="p">)</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]</span>
<span class="o">&lt;</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">CursorResult</span> <span class="nb">object</span> <span class="n">at</span> <span class="mi">0</span><span class="n">x</span><span class="o">...&gt;</span>
<span class="n">COMMIT</span>
</code></pre></div>
<p>В приведенном выше примере мы выполняем два SQL-запроса, которые, как правило, являются транзакционными: запрос на "
CREATE TABLE" [<a href="#mark-1">1</a>] и запрос на "INSERT", параметризованный (синтаксис параметризации выше будет рассмотрен
ниже в
разделе "Отправка нескольких параметров"). Так как мы хотим, чтобы наша работа была зафиксирована в рамках блока, мы
вызываем метод Connection.commit(), который фиксирует транзакцию. После того как мы вызвали этот метод внутри блока, мы
можем продолжить выполнять SQL-запросы и, если хотим, можем вызвать Connection.commit() еще раз для последующих
запросов. SQLAlchemy называет этот стиль "фиксирование изменений по мере выполнения".</p>
<p>Есть еще один способ фиксации данных, который заключается в том, что мы можем заранее объявить наш блок "connect" как
блок транзакции. Для этого режима работы мы используем метод Engine.begin() для получения соединения вместо метода
Engine.connect(). Этот метод будет управлять областью действия Connection и также заключит все внутри транзакции с
COMMIT в конце, в случае успешного выполнения блока, или ROLLBACK в случае возникновения исключения. Этот стиль может
быть назван "begin once":</p>
<div class="highlight"><pre><span></span><code><span class="c1"># &quot;begin once&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="o">...</span>         <span class="n">text</span><span class="p">(</span><span class="s2">&quot;INSERT INTO some_table (x, y) VALUES (:x, :y)&quot;</span><span class="p">),</span>
<span class="o">...</span>         <span class="p">[{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}],</span>
<span class="o">...</span>     <span class="p">)</span>

<span class="c1"># SQL</span>
<span class="n">BEGIN</span> <span class="p">(</span><span class="n">implicit</span><span class="p">)</span>
<span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">some_table</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="err">?</span><span class="p">,</span> <span class="err">?</span><span class="p">)</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="p">[(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">)]</span>
<span class="o">&lt;</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">CursorResult</span> <span class="nb">object</span> <span class="n">at</span> <span class="mi">0</span><span class="n">x</span><span class="o">...&gt;</span>
<span class="n">COMMIT</span>
</code></pre></div>
<p>Стиль "begin once" часто предпочитается, так как он более лаконичен и позволяет заранее указать намерение всего
блока. Однако в этом руководстве мы обычно будем использовать стиль "фиксировать по мере выполнения", так как он более
гибкий для демонстрационных целей.</p>
<div class="admonition info">
<p class="admonition-title">Что такое "BEGIN (implicit)"?</p>
<p>Вы могли заметить строку журнала "BEGIN (implicit)" в начале блока транзакции. "implicit" здесь означает, что SQLAlchemy
на самом деле не отправляет никакую команду в базу данных; он просто считает это началом неявной транзакции DBAPI. Вы
можете зарегистрировать события для перехвата этого события, например. </p>
</div>
<h4 id="mark-1">примечание [1]</h4>
<p>DDL относится к подмножеству SQL, которое указывает базе данных создавать, изменять или удалять конструкции на уровне
схемы, такие как таблицы. Рекомендуется помещать DDL, такой, как "CREATE TABLE", в блок транзакции, который
заканчивается
COMMIT, так как многие базы данных используют транзакционный DDL, при котором изменения схемы не происходят до тех пор,
пока транзакция не будет зафиксирована. Однако, как мы увидим позже, обычно мы позволяем SQLAlchemy запускать
последовательности DDL для нас как часть операции более высокого уровня, где нам обычно не нужно беспокоиться о COMMIT.</p>
<hr />
<h3 id="statements">Основы выполнения утверждений(statements)</h3>
<p>Мы рассмотрели несколько примеров выполнения операторов SQL в базе данных, используя метод Connection.execute()
совместно с объектом text() и возвращающимся объектом Result. В этом разделе мы более подробно проиллюстрируем механику
и взаимодействие этих компонентов.</p>
<details class="info" open="open">
<summary>Об разделе</summary>
<p>Большая часть содержимого этого раздела одинаково хорошо применима и к современному использованию ORM, при использовании
метода Session.execute(), который работает очень похоже на Connection.execute(), включая то, что строки результатов ORM
доставляются с использованием того же интерфейса Result, что и в Core.</p>
</details>
<h4 id="_1">Извлечение строк</h4>
<p>Сначала мы более детально рассмотрим объект Result, используя строки, которые мы ранее вставляли, выполняя текстовый
оператор SELECT на созданной нами таблице:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT x, y FROM some_table&quot;</span><span class="p">))</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<span class="o">...</span>         <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x: </span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">x</span><span class="si">}</span><span class="s2"> y: </span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">y</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># SQL</span>
<span class="n">BEGIN</span> <span class="p">(</span><span class="n">implicit</span><span class="p">)</span>
<span class="n">SELECT</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="n">FROM</span> <span class="n">some_table</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="p">()</span>

<span class="c1"># Python output</span>
<span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="n">y</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="n">y</span><span class="p">:</span> <span class="mi">4</span>
<span class="n">x</span><span class="p">:</span> <span class="mi">6</span> <span class="n">y</span><span class="p">:</span> <span class="mi">8</span>
<span class="n">x</span><span class="p">:</span> <span class="mi">9</span> <span class="n">y</span><span class="p">:</span> <span class="mi">10</span>

<span class="n">ROLLBACK</span>
</code></pre></div>
<p>В приведенном выше примере строка "SELECT" выбрала все строки из нашей таблицы. Возвращаемый объект называется Result и
представляет итерируемый объект строк результатов.</p>
<p>У Result есть много методов для извлечения и преобразования строк, таких как метод Result.all (), показанный ранее,
который возвращает список всех объектов Row. Он также реализует интерфейс Python итератора, чтобы мы могли прямо
перебирать коллекцию объектов Row.</p>
<p>Сами объекты Row реализованы как именованные кортежи Python. Ниже мы иллюстрируем различные способы доступа к
строкам.</p>
<ul>
<li>
<p><strong>Распаковка кортежей</strong> - Это наиболее Python-идиоматичный стиль, который заключается в присваивании переменных каждой
  позиции строки при ее получении:</p>
<div class="highlight"><pre><span></span><code><span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;select x, y from some_table&quot;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<span class="o">...</span>
</code></pre></div>
</li>
<li>
<p><strong>По индексу</strong> - Кортежи являются последовательностями Python, так что доступ по обычному целочисленному индексу
  также доступен:</p>
<div class="highlight"><pre><span></span><code><span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;select x, y from some_table&quot;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>
</li>
<li>
<p><strong>По имени атрибута</strong> - Поскольку это именованные кортежи Python, кортежи имеют динамические имена атрибутов,
  соответствующие
  именам каждого столбца. Эти имена обычно соответствуют именам, которые оператор SQL присваивает столбцам в каждой
  строке. Хотя они обычно достаточно предсказуемы и могут также управляться метками, в менее определенных случаях они
  могут подвергаться воздействию специфичных для базы данных поведений:</p>
<div class="highlight"><pre><span></span><code><span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;select x, y from some_table&quot;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">y</span>

    <span class="c1"># illustrate use with Python f-strings</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Row: </span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">x</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<ul>
<li><strong>По словарю</strong> - Для получения строк в виде объектов отображения Python, которые являются существенно только для
  чтения версией
  интерфейса Python для общего объекта dict, Result может быть преобразован в объект MappingResult с помощью
  модификатора
  Result.mappings(); это объект результата, который возвращает объекты RowMapping, похожие на словари, вместо
  объектов
  Row:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;select x, y from some_table&quot;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">dict_row</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">mappings</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">dict_row</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">dict_row</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
</code></pre></div>
</li>
</ul>
<h4 id="_2">Передача параметров</h4>
<p>SQL-запросы обычно сопровождаются данными, которые необходимо передать вместе с запросом, как мы видели в примере с
INSERT ранее. Метод Connection.execute() также принимает параметры, которые называются связанными параметрами. Примером
может быть запрос SELECT, который ограничивает количество строк, удовлетворяющих определенным условиям, таким как
строки, где значение поля "y" больше определенного значения, которое передается в функцию.</p>
<p>Чтобы этого достичь и при этом запрос SQL мог оставаться неизменным, а драйвер мог правильно обработать значение, мы
добавляем в WHERE-критерий запроса параметр с именем "y"; для этого мы используем конструкцию text(), в которую
добавляем "y" в формате с двоеточием " :y". Фактическое значение для ":y" передается вторым аргументом в
Connection.execute() в виде словаря:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT x, y FROM some_table WHERE y &gt; :y&quot;</span><span class="p">),</span> <span class="p">{</span><span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<span class="o">...</span>         <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x: </span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">x</span><span class="si">}</span><span class="s2">  y: </span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">y</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">BEGIN</span> <span class="p">(</span><span class="n">implicit</span><span class="p">)</span>
<span class="n">SELECT</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="n">FROM</span> <span class="n">some_table</span> <span class="n">WHERE</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="err">?</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span>

<span class="n">x</span><span class="p">:</span> <span class="mi">2</span>  <span class="n">y</span><span class="p">:</span> <span class="mi">4</span>
<span class="n">x</span><span class="p">:</span> <span class="mi">6</span>  <span class="n">y</span><span class="p">:</span> <span class="mi">8</span>
<span class="n">x</span><span class="p">:</span> <span class="mi">9</span>  <span class="n">y</span><span class="p">:</span> <span class="mi">10</span>

<span class="n">ROLLBACK</span>
</code></pre></div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023 Elisha Kravchuk
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.indexes", "content.code.copy"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.51198bba.min.js"></script>
      
    
  <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>